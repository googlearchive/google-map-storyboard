<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="bower_components/google-apis/google-apis.html">
<link rel="import" href="google-map-scene.html">

<polymer-element name="google-map-storyboard" attributes="apiKey">
<template>
  <style>
    :host {
      position: relative;
      display: block;
      height: 100%;
    }
    #map {
      position: absolute;
      top: 0;
      right: 0;
      bottom: 0;
      left: 0;
    }
  </style>
  <google-maps-api apiKey="{{apiKey}}" version="3.exp" libraries="places,geometry" on-api-load="{{mapApiLoaded}}"></google-maps-api>
  <div id='map'> </div>
  <content id='scenes' select='google-map-scene'></content>
</template>


<script>
(function() {
  Polymer({
    /**
     * An array of the google-map-scene's contained within the storyboard.
     * 
     * @property scenes
     * @type Array of google-map-scene
     * @default null
     */
    scenes: null,

    /**
     * The google map used in the storyboard.
     * 
     * @property map
     * @type google.maps.Map
     * @default null
     */
    map: null,

    /**
     * The Google Map API key to be used. To obtain an API key, see developers.google.com/maps/documentation/javascript/tutorial#api_key.
     * 
     * @property apiKey
     * @default null
     */
    apiKey:null,

    /**
     * This is the index of the current scene. 
     *
     * This method of handling current should only be used in the linear case.
     * TODO: Modify so that the current is accessed using id's.
     * 
     * @property current
     * @type Number
     * @default 0
     */
    current: 0,

    /**
     * The location of the current scene.
     *
     * @property currentLoc
     * @type google.maps.LatLng
     * @default null
     */
    currentLoc: null,

    mapApiLoaded: function() {
      this.updateScenes();
    },

    initialiseMap: function() {
      if (!this.map && this.currentLoc) {
        var mapOptions = {
          center: this.currentLoc,
          zoom: 10,
        };
        this.map = new google.maps.Map(this.$.map, mapOptions);
      }
    },

    updateScenes: function() {
      this.scenes = Array.prototype.slice.call(
          this.$.scenes.getDistributedNodes());
      this.index = 0; 
      this.updateLocations();
    },

    /*
     * This function is recursively called to get the LatLng location of each of the scenes (using geocoding).
     *
     */
    updateLocations: function() {
      if (this.index <this.scenes.length ) {
        var geocoder = new google.maps.Geocoder();
        var address = this.scenes[this.index].address;
        geocoder.geocode( {address: address}, function(place, status) {
          if (status == google.maps.GeocoderStatus.OK) {
            this.scenes[this.index].location = place[0].geometry.location;
          }
          this.index++;
          this.updateLocations();
        }.bind(this));
      } else {
        this.updateCurrentLoc();
        this.index = null;
      }
    },

    updateCurrentLoc: function() {
      if (!this.currentLoc && typeof this.current === 'number') {
        this.currentLoc = this.scenes[this.current].location;
      }
      if (!this.map) {
        this.initialiseMap();        
      }
    },
  });
})();
</script>
</polymer-element>